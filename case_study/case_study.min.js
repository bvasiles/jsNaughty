var vm = require("vm"), _ = require("underscore"), async = require("async"), csv = require("csv"), request = require("request").defaults({
    json: true
}), http = require("http"), crypto = require("crypto"), stream = require("stream");

module.exports = http.createServer(function(e, r) {
    var t, a;
    var i = new stream.Stream();
    i.writeable = true;
    i.readable = true;
    i.pipe(r);
    var n = "";
    csv().fromStream(e).on("data", function(e, r) {
        if (!t) {
            i.emit("data", '{"docs":[');
            t = e;
            return;
        }
        var a = {};
        _(_.zip(t, e)).each(function(e) {
            a[_.first(e)] = _.last(e);
        });
        i.emit("data", n + JSON.stringify(a));
        n = ",";
    }).on("end", function(e) {
        i.emit("data", "]}");
        i.emit("end");
    }).on("error", function(e) {
        i.emit("error", e);
        console.log("csv error", e.message);
    });
});
